<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mi cuenta | JCDM</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div id="header"></div>
  <main class="container">
    <h1>Mi cuenta</h1>
    <form id="profileForm" class="card" style="max-width:520px">
      <label>Nombre completo
        <input name="full_name" placeholder="Tu nombre y apellido">
      </label>
      <label>Teléfono
        <input name="phone" placeholder="+1 305 000 0000">
      </label>
      <div class="grid grid-2">
        <button class="btn btn-primary" type="submit">Guardar</button>
        <button class="btn" type="button" id="logoutBtn">Cerrar sesión</button>
      </div>
      <p id="msg" class="muted"></p>
    </form>
  </main>
  <div id="footer"></div>

  <script src="/js/app.js" defer></script>
  <script src="/js/supabase.config.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(window.__SUPABASE__.url, window.__SUPABASE__.anon);
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) location.href = "/login.html?next=/mi-cuenta.html";

    const form = document.getElementById('profileForm');
    const msg  = document.getElementById('msg');

    // Cargar datos actuales
    const { data: prof } = await supabase.from('profiles')
      .select('full_name,phone').eq('id', session.user.id).single();
    if (prof) {
      form.full_name.value = prof.full_name || '';
      form.phone.value     = prof.phone || '';
    }

    // Guardar cambios
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const o = Object.fromEntries(new FormData(form).entries());
      const { error } = await supabase.from('profiles')
        .upsert({ id: session.user.id, full_name: o.full_name, phone: o.phone }, { onConflict: 'id' });
      msg.textContent = error ? ('Error: '+error.message) : 'Datos guardados.';
    });

    document.getElementById('logoutBtn').onclick = async ()=>{
      await supabase.auth.signOut(); location.href = "/";
    };
  </script>
</body>
</html>
